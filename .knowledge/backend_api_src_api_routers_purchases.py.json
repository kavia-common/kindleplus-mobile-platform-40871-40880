{"is_source_file": true, "format": "Python", "description": "This file defines API routes for managing purchase-related actions in a FastAPI application, including listing, creating, and retrieving purchases for authenticated users. It interacts with database models for Purchase, Book, User, and Library, handles pagination, and ensures security via user authentication.", "external_files": ["src/db/session.py", "src/models/book.py", "src/models/library.py", "src/models/purchase.py", "src/models/user.py", "src/schemas/purchase.py", "src/services/auth_service.py", "src/utils/pagination.py"], "external_methods": ["get_db", "get_current_user", "PageMeta.build", "PurchaseRead.model_validate", "sanitize_pagination", "offset_limit"], "published": ["list_purchases", "create_purchase", "get_purchase"], "classes": [], "methods": [{"name": "Select _query_user_purchases_base(user_id: str)", "description": "Builds a base select statement to retrieve a user's purchases with related book and user data preloaded.", "scope": "", "scopeKind": ""}, {"name": "Paginated[PurchaseRead] list_purchases( page: int = Query(default=1, ge=1, description=\"Page number (1-based)\"), page_size: int = Query(default=20, ge=1, le=100, description=\"Items per page\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Handles GET requests to list paginated purchases for the authenticated user.", "scope": "", "scopeKind": ""}, {"name": "PurchaseRead create_purchase( payload: PurchaseCreate, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Handles POST requests to create a new purchase for the authenticated user, and adds the book to user's library if not already present.", "scope": "", "scopeKind": ""}, {"name": "PurchaseRead get_purchase( purchase_id: str, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )", "description": "Retrieves a specific purchase by ID, verifying that it belongs to the current user.", "scope": "", "scopeKind": ""}], "calls": ["select(Purchase)", "selectinload(Purchase.book)", "selectinload(Purchase.user)", "db.scalar(...)", "db.execute(...)", "db.get(Book, payload.book_id)", "db.add(...)", "db.commit()", "db.refresh(...)", "select(Library)", "select(Purchase).where(...)", "select(Purchase).order_by(...)"], "search-terms": ["purchases API", "FastAPI purchase routes", "purchase management", "user purchases", "pagination", "transaction processing"], "state": 2, "file_id": 41, "knowledge_revision": 97, "git_revision": "", "ctags": [{"_type": "tag", "name": "_query_user_purchases_base", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/purchases.py", "pattern": "/^def _query_user_purchases_base(user_id: str) -> Select:$/", "language": "Python", "typeref": "typename:Select", "kind": "function", "signature": "(user_id: str)"}, {"_type": "tag", "name": "create_purchase", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/purchases.py", "pattern": "/^def create_purchase($/", "language": "Python", "typeref": "typename:PurchaseRead", "kind": "function", "signature": "( payload: PurchaseCreate, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "get_purchase", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/purchases.py", "pattern": "/^def get_purchase($/", "language": "Python", "typeref": "typename:PurchaseRead", "kind": "function", "signature": "( purchase_id: str, db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "list_purchases", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/purchases.py", "pattern": "/^def list_purchases($/", "language": "Python", "typeref": "typename:Paginated[PurchaseRead]", "kind": "function", "signature": "( page: int = Query(default=1, ge=1, description=\"Page number (1-based)\"), page_size: int = Query(default=20, ge=1, le=100, description=\"Items per page\"), db: Session = Depends(get_db), current_user: User = Depends(get_current_user), )"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/purchases.py", "pattern": "/^router = APIRouter(prefix=\"\\/purchases\", tags=[\"Purchases\"])$/", "language": "Python", "kind": "variable"}], "hash": "e54287769582c26120f22aa4a790f894", "format-version": 4, "code-base-name": "backend_api", "filename": "backend_api/src/api/routers/purchases.py", "fields": [{"name": "router = APIRouter(prefix=\"\\/purchases\", tags=[\"Purchases\"])", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"97": ""}]}