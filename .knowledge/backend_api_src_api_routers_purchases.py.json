{"is_source_file": true, "format": "Python", "description": "FastAPI router module for managing user purchases, including listing, creating, and retrieving purchase records with database interactions and pagination.", "external_files": ["src/db/session.py", "src/models/book.py", "src/models/library.py", "src/models/purchase.py", "src/models/user.py", "src/schemas/purchase.py", "src/services/auth_service.py", "src/utils/pagination.py"], "external_methods": ["get_db", "get_current_user", "select", "func.count", "selectinload", "PageMeta.build", "offset_limit", "sanitize_pagination"], "published": ["router"], "classes": [], "methods": [{"name": "_query_user_purchases_base", "description": "Builds a base SQLAlchemy select statement for fetching a user's purchases with related book and user data preloaded."}, {"name": "list_purchases", "description": "Handles GET requests to list the authenticated user's purchases with pagination."}, {"name": "create_purchase", "description": "Handles POST requests to create a new purchase for the authenticated user, adding the book to the user's library if not already present."}, {"name": "get_purchase", "description": "Handles GET requests to retrieve a specific purchase by ID, ensuring it belongs to the current user."}], "calls": ["select", "func.count", "selectinload", "PageMeta.build", "offset_limit", "sanitize_pagination", "db.scalar", "db.get", "db.execute", "db.add", "db.commit", "db.refresh", "PurchaseRead.model_validate"], "search-terms": ["purchases", "purchase management", "purchase API", "user purchases", "purchase creation", "purchase retrieval", "pagination", "FastAPI router"], "state": 2, "file_id": 41, "knowledge_revision": 152, "git_revision": "5e046654ba1542ba7515b52443888823594448fb", "revision_history": [{"97": ""}, {"152": "5e046654ba1542ba7515b52443888823594448fb"}], "ctags": [], "filename": "backend_api/src/api/routers/purchases.py", "format-version": 4, "code-base-name": "https://github.com/kavia-common/kindleplus-mobile-platform-40871-40880.git:kavia-main"}