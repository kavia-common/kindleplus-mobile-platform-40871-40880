{"is_source_file": true, "format": "Python", "description": "This file defines API routes for handling payment initialization and webhooks in a FastAPI application. It includes functions for creating payment sessions, verifying tokens, and processing webhook events related to payments and purchases.", "external_files": [".../services/payments_service", ".../services/auth_service", ".../db/session", ".../models/purchase", ".../models/book"], "external_methods": ["get_payment_provider", "get_token_payload"], "published": ["router"], "classes": [{"name": "PaymentInitRequest", "description": "Pydantic model for payment initialization request, containing book ID and optional currency."}, {"name": "PaymentInitResponse", "description": "Pydantic model for response after payment session creation, indicating provider and session data."}], "methods": [{"name": "_get_db()", "description": "Creates and manages a database session, closing it after use.", "scope": "", "scopeKind": ""}, {"name": "_auth_required(authorization: Optional[str] = Header(None))", "description": "Extracts and verifies Bearer token from request headers for authentication.", "scope": "", "scopeKind": ""}, {"name": "create_payment_session(req: PaymentInitRequest, auth=Depends(_auth_required), db: Session = Depends(_get_db))", "description": "API endpoint to initialize a payment session for a specific book, returning session info from payment provider.", "scope": "", "scopeKind": ""}, {"name": "payment_webhook(request: Request, db: Session = Depends(_get_db))", "description": "API endpoint to handle webhook callbacks from payment providers, verifying transactions and checking for existing purchases.", "scope": "", "scopeKind": ""}], "calls": ["get_payment_provider()", "get_token_payload(token, expected_type=\"access\")", "db.query(Book).filter(Book.id == req.book_id).first()", "provider.create_session(user_id=..., book_id=..., amount_cents=..., currency=...)", "provider.verify_webhook(payload, headers)", "db.query(Purchase).filter(Purchase.transaction_id == transaction_id).first()"], "search-terms": ["payment session", "webhook handler", "purchase transaction", "PaymentInitRequest", "PaymentInitResponse"], "state": 2, "file_id": 47, "knowledge_revision": 159, "git_revision": "ba179e9cf3373dfe251d8ce58c3eddcd821be757", "revision_history": [{"118": ""}, {"134": ""}, {"159": "ba179e9cf3373dfe251d8ce58c3eddcd821be757"}], "ctags": [{"_type": "tag", "name": "PaymentInitRequest", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^class PaymentInitRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "PaymentInitResponse", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^class PaymentInitResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_auth_required", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^def _auth_required(authorization: Optional[str] = Header(None)):$/", "language": "Python", "kind": "function", "signature": "(authorization: Optional[str] = Header(None))"}, {"_type": "tag", "name": "_get_db", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^def _get_db():$/", "language": "Python", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "book_id", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^    book_id: str = Field(..., description=\"Book ID to purchase\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "PaymentInitRequest", "scopeKind": "class"}, {"_type": "tag", "name": "create_payment_session", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^def create_payment_session(req: PaymentInitRequest, auth=Depends(_auth_required), db: Session = /", "language": "Python", "kind": "function", "signature": "(req: PaymentInitRequest, auth=Depends(_auth_required), db: Session = Depends(_get_db))"}, {"_type": "tag", "name": "currency", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^    currency: Optional[str] = Field(None, description=\"Currency code, defaults to backend settin/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "PaymentInitRequest", "scopeKind": "class"}, {"_type": "tag", "name": "payment_webhook", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^async def payment_webhook(request: Request, db: Session = Depends(_get_db)):$/", "language": "Python", "kind": "function", "signature": "(request: Request, db: Session = Depends(_get_db))"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/kindleplus-mobile-platform-40871-40880/backend_api/src/api/routers/payments.py", "pattern": "/^router = APIRouter()$/", "language": "Python", "kind": "variable"}], "hash": "298782ce6d24b6b51954331b762a0d27", "format-version": 4, "code-base-name": "backend_api", "filename": "backend_api/src/api/routers/payments.py", "fields": [{"name": "str book_id", "scope": "PaymentInitRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] currency", "scope": "PaymentInitRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "router = APIRouter()", "scope": "", "scopeKind": "", "description": "unavailable"}]}